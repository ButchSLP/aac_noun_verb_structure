<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AAC Noun + Verb - The Full Result Edition</title>
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        body { display: flex; align-items: center; justify-content: center; padding: 5px; box-sizing: border-box; }
        
        #game-container, #result-screen { 
            width: 100%; max-width: 1200px; height: 98vh; background: white; 
            padding: 15px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; box-sizing: border-box; 
            position: relative; overflow: hidden; 
        }

        #progress-container { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; background: #f8f9fa; padding: 10px; border-radius: 12px; flex-shrink: 0; }
        .progress-node { width: 25px; height: 25px; border-radius: 50%; background: #dfe6e9; border: 2px solid #b2bec3; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; color: #636e72; }
        .node-active { border-color: #3498db; background: #fff; box-shadow: 0 0 8px rgba(52, 152, 219, 0.5); transform: scale(1.1); color: #3498db; }
        .node-complete { background: #2ecc71; border-color: #27ae60; color: white; }
        .score-display { margin-left: auto; font-weight: bold; color: #2c3e50; font-size: 0.9rem; }

        #main-content { display: flex; flex-direction: row; gap: 15px; flex-grow: 1; min-height: 0; }
        #gif-container { flex: 1.2; background: #eee; border-radius: 15px; display: flex; align-items: center; justify-content: center; border: 2px solid #ddd; overflow: hidden; }
        #trial-gif { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        #workspace { flex: 1; display: flex; flex-direction: column; gap: 8px; min-width: 300px; min-height: 0; }
        #drop-zone { flex-shrink: 0; display: flex; gap: 8px; padding: 10px; background: #fff; border: 3px dashed #3498db; min-height: 110px; border-radius: 15px; justify-content: center; align-items: center; }
        .bank { flex-grow: 1; display: flex; gap: 8px; justify-content: center; align-content: center; flex-wrap: wrap; padding: 10px; background: #f9f9f9; border-radius: 10px; border: 2px solid #eee; overflow-y: auto; }
        
        .symbol { padding: 3px; border-radius: 10px; cursor: grab; font-weight: bold; width: 115px; height: 100px; font-size: 0.8rem; box-shadow: 0 3px 5px rgba(0,0,0,0.1); text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: space-between; box-sizing: border-box; background: #E0E0E0; }
        .symbol img { width: 65px; height: 65px; object-fit: contain; margin-top: 2px; pointer-events: none; }
        .symbol span { margin-bottom: 2px; line-height: 1; }
        .who { border: 4px solid #FFFF00; } 
        .doing { border: 4px solid #2ECC71; } 
        .dragging { opacity: 0.3; }

        #feedback { font-weight: bold; font-size: 1.1rem; height: 25px; text-align: center; margin: 2px 0; }
        .action-area { display: flex; justify-content: center; padding-bottom: 5px; flex-shrink: 0; }
        button { padding: 10px 25px; font-size: 0.9rem; cursor: pointer; border-radius: 50px; border: none; font-weight: bold; }
        #check-btn { background: #3498db; color: white; }
        #next-btn { background: #2ecc71; color: white; display: none; }

        /* REWARD SCREENS */
        #dance-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1500; display: none; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border-radius: 20px; pointer-events: auto; }
        #celebration-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.98); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; transition: opacity 1.5s ease; }
        .funky-pulse { animation: funkyBackground 3s infinite; }
        @keyframes funkyBackground { 0% { background-color: rgba(155, 89, 182, 0.9); } 33% { background-color: rgba(52, 152, 219, 0.9); } 66% { background-color: rgba(46, 204, 113, 0.9); } 100% { background-color: rgba(155, 89, 182, 0.9); } }
        #dance-gif, #celebration-gif { max-width: 90%; max-height: 80%; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }

        /* RESULTS UI */
        #result-header { display: flex; align-items: center; justify-content: center; gap: 30px; margin-bottom: 10px; flex-shrink: 0; }
        .mini-party-gif { width: 80px; height: 80px; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; padding: 12px; border-bottom: 2px solid #dee2e6; text-align: left; color: #495057; font-size: 0.9rem; }
        td { padding: 10px; border-bottom: 1px solid #eee; color: #2c3e50; font-size: 0.85rem; }

        /* START SCREEN */
        #audio-unlock-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(-45deg, #3498db, #2ecc71, #9b59b6); background-size: 400% 400%; animation: gradientBG 10s ease infinite; color: white; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .card { background: rgba(255, 255, 255, 0.2); padding: 30px; border-radius: 30px; backdrop-filter: blur(12px); border: 2px solid rgba(255, 255, 255, 0.3); width: 320px; }
        #settings-modal { display: none; position: absolute; background: white; color: #333; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 3500; width: 280px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="audio-unlock-overlay">
        <div class="card" id="start-card">
            <h1>üê∂ Let's Play!</h1>
            <p>Ready to build sentences?</p>
            <button style="background: white; color: #3498db; font-size: 1.8rem; padding: 15px 45px; border-radius: 100px; border: none; cursor: pointer; font-weight: bold;" onclick="startApp()">START</button>
            <br>
            <button onclick="toggleSettings()" style="background:none; border:2px solid white; color:white; margin-top:15px; padding:8px 20px; border-radius:20px; font-size:0.8rem; cursor:pointer;">‚öô Settings</button>
        </div>
        <div id="settings-modal">
            <h3>Trial Settings</h3>
            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                <span>Number of Foils:</span>
                <span id="foil-val" style="color:#3498db;">2</span>
            </div>
            <input type="range" id="foil-slider" min="0" max="3" value="2" oninput="updateFoilText(this.value)" style="width:100%; margin:15px 0;">
            <button onclick="toggleSettings()" style="background:#3498db; color:white; width:100%; padding:10px; border-radius:10px; border:none; font-weight:bold;">Save & Close</button>
        </div>
    </div>

    <div id="dance-overlay" onclick="nextTrial()">
        <img id="dance-gif" src="" alt="Dancing animal">
    </div>

    <div id="celebration-overlay">
        <h1 style="color:#2ecc71; font-size: 3rem; margin-bottom:10px;">FANTASTIC!</h1>
        <img id="celebration-gif" src="images/dancing_cartoon.gif" alt="Celebration!">
    </div>

    <div id="game-container">
        <div id="progress-container">
            <div class="progress-node" id="node-0">1</div><div class="progress-node" id="node-1">2</div>
            <div class="progress-node" id="node-2">3</div><div class="progress-node" id="node-3">4</div>
            <div class="progress-node" id="node-4">5</div><div class="progress-node" id="node-5">6</div>
            <div class="progress-node" id="node-6">7</div><div class="progress-node" id="node-7">8</div>
            <div class="progress-node" id="node-8">9</div><div class="progress-node" id="node-9">10</div>
            <div class="score-display">Score: <span id="score-val">0</span></div>
        </div>
        <div id="main-content">
            <div id="gif-container"><img id="trial-gif" src="" alt="Loading..."></div>
            <div id="workspace">
                <div id="drop-zone"></div>
                <div class="bank" id="word-bank"></div>
                <div id="feedback"></div>
                <div class="action-area">
                    <button id="check-btn" onclick="checkAnswer()">Check Answer</button>
                    <button id="next-btn" onclick="nextTrial()">Next Trial &rarr;</button>
                </div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <div id="result-header">
            <img class="mini-party-gif" id="result-party-left" src="images/dancing_cartoon.gif" alt="party">
            <div style="text-align:center;">
                <h1 style="margin: 0; color: #2c3e50; font-size: 1.1rem;">Final Score</h1>
                <div style="font-size: 2.5rem; color: #3498db; font-weight:bold;" id="final-pct">0%</div>
            </div>
            <img class="mini-party-gif" id="result-party-right" src="images/dancing_cartoon.gif" alt="party">
        </div>
        <div style="flex-grow: 1; overflow-y: auto;">
            <table>
                <thead>
                    <tr><th>Trial</th><th>Target Sentence</th><th>Result</th></tr>
                </thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
        <button onclick="location.reload()" style="background:#34495e; color:white; margin:10px auto; padding:12px 40px; border-radius:30px; display:block; font-size:1.1rem;">Play Again</button>
    </div>

    <script>
        let numFoils = 2;
        const sounds = {
            drop: new Audio('sounds/drop.mp3'),
            incorrect: new Audio('sounds/incorrect_answer.mp3'),
            celebration: new Audio('sounds/celebration_song.mp3'),
            funky1: new Audio('sounds/funky_one.mp3'),
            funky2: new Audio('sounds/funky_two.mp3'),
            funky3: new Audio('sounds/funky_three.mp3')
        };
        const danceGifs = ['images/animal_dancing_one.gif', 'images/animal_dancing_two.gif', 'images/animal_dancing_three.gif', 'images/animal_dancing_four.gif', 'images/animal_dancing_five.gif'];
        const funkyKeys = ['funky1', 'funky2', 'funky3'];
        let activeSound = null, globalTrialId = 0, danceFader = null;

        function toggleSettings() {
            const m = document.getElementById('settings-modal');
            m.style.display = (m.style.display === 'block') ? 'none' : 'block';
        }
        function updateFoilText(val) {
            numFoils = parseInt(val);
            document.getElementById('foil-val').innerText = val;
        }

        function startApp() {
            for (let key in sounds) {
                sounds[key].play().then(() => { sounds[key].pause(); sounds[key].currentTime = 0; }).catch(() => {});
            }
            document.getElementById('audio-unlock-overlay').style.display = 'none';
            loadTrial();
        }

        function speak(text, callback) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            const id = globalTrialId;
            if (callback) u.onend = () => { if (id === globalTrialId) callback(); };
            window.speechSynthesis.speak(u);
        }

        const trialsData = [
             { gif: "images/dog_smelling.gif", correctWho: "The dog", whoImg: "symbols/dog.png", correctDoing: "is smelling", doingImg: "symbols/smell.png", distWho: "The cat", distWhoImg: "symbols/cat.png", distDoing: "is sleeping", distDoingImg: "symbols/sleep.png" },
             { gif: "images/girl_running.gif", correctWho: "The girl", whoImg: "symbols/girl.png", correctDoing: "is running", doingImg: "symbols/run.png", distWho: "The boy", distWhoImg: "symbols/boy.png", distDoing: "is eating", distDoingImg: "symbols/eat.png" },
             { gif: "images/cat_jumping.gif", correctWho: "The cat", whoImg: "symbols/cat.png", correctDoing: "is jumping", doingImg: "symbols/jump.png", distWho: "The bird", distWhoImg: "symbols/bird.png", distDoing: "is flying", distDoingImg: "symbols/fly.png" },
             { gif: "images/boy_eating.gif", correctWho: "The boy", whoImg: "symbols/boy.png", correctDoing: "is eating", doingImg: "symbols/eat.png", distWho: "The teacher", distWhoImg: "symbols/teacher.png", distDoing: "is writing", distDoingImg: "symbols/write.png" },
             { gif: "images/baby_crying.gif", correctWho: "The baby", whoImg: "symbols/baby.png", correctDoing: "is crying", doingImg: "symbols/cry.png", distWho: "The man", distWhoImg: "symbols/man.png", distDoing: "is washing", distDoingImg: "symbols/wash.png" },
             { gif: "images/bird_flying.gif", correctWho: "The bird", whoImg: "symbols/bird.png", correctDoing: "is flying", doingImg: "symbols/fly.png", distWho: "The dog", distWhoImg: "symbols/dog.png", distDoing: "is talking", distDoingImg: "symbols/talk.png" },
             { gif: "images/fish_looking.gif", correctWho: "The fish", whoImg: "symbols/fish.png", correctDoing: "is looking", doingImg: "symbols/look.png", distWho: "The octopus", distWhoImg: "symbols/octopus.png", distDoing: "is dancing", distDoingImg: "symbols/dance.png" },
             { gif: "images/man_cutting.gif", correctWho: "The man", whoImg: "symbols/man.png", correctDoing: "is cutting", doingImg: "symbols/cut.png", distWho: "The woman", distWhoImg: "symbols/woman.png", distDoing: "is holding", distDoingImg: "symbols/hold.png" },
             { gif: "images/man_washing.gif", correctWho: "The man", whoImg: "symbols/man.png", correctDoing: "is washing", doingImg: "symbols/wash.png", distWho: "The baby", distWhoImg: "symbols/baby.png", distDoing: "is crying", distDoingImg: "symbols/cry.png" },
             { gif: "images/girl_reading.gif", correctWho: "The girl", whoImg: "symbols/girl.png", correctDoing: "is reading", doingImg: "symbols/read.png", distWho: "The cat", distWhoImg: "symbols/cat.png", distDoing: "is flying", distDoingImg: "symbols/fly.png" }
        ];

        let currentIndex = 0, score = 0, trialLog = [];

        function loadTrial() {
            const nodes = document.querySelectorAll('.progress-node');
            nodes.forEach((n, i) => { n.classList.remove('node-active'); if (i === currentIndex) n.classList.add('node-active'); });
            const trial = trialsData[currentIndex];
            document.getElementById('trial-gif').src = trial.gif;
            document.getElementById('drop-zone').innerHTML = "";
            document.getElementById('feedback').innerText = "";
            document.getElementById('check-btn').style.display = "inline-block";
            document.getElementById('next-btn').style.display = "none";
            document.getElementById('dance-overlay').style.display = "none";
            
            let items = [{ text: trial.correctWho, type: "who", img: trial.whoImg }, { text: trial.correctDoing, type: "doing", img: trial.doingImg }];
            const potentialFoils = [{ text: trial.distWho, type: "who", img: trial.distWhoImg }, { text: trial.distDoing, type: "doing", img: trial.distDoingImg }];
            for(let i=0; i < numFoils; i++) {
                if (i < 2) items.push(potentialFoils[i]);
                else if (i === 2) { const other = trialsData[(currentIndex + 1) % 10]; items.push({ text: other.correctWho, type: "who", img: other.whoImg }); }
            }
            const bank = document.getElementById('word-bank'); bank.innerHTML = "";
            items.sort(() => Math.random() - 0.5).forEach(item => {
                const div = document.createElement('div');
                div.className = `symbol ${item.type}`;
                div.draggable = true; div.dataset.text = item.text;
                div.innerHTML = `<img src="${item.img}"><span>${item.text}</span>`;
                div.addEventListener('pointerdown', () => speak(item.text));
                div.addEventListener('dragstart', (e) => e.target.classList.add('dragging'));
                div.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                    if (e.target.parentElement.id === "drop-zone") { sounds.drop.currentTime = 0; sounds.drop.play(); }
                });
                bank.appendChild(div);
            });
        }

        const dropZone = document.getElementById('drop-zone');
        const wordBank = document.getElementById('word-bank');
        [dropZone, wordBank].forEach(zone => {
            zone.addEventListener('dragover', e => e.preventDefault());
            zone.addEventListener('drop', e => { const d = document.querySelector('.dragging'); if (d) zone.appendChild(d); });
        });

        function checkAnswer() {
            const placed = Array.from(dropZone.children);
            const trial = trialsData[currentIndex];
            const isCorrect = (placed.length === 2) && (placed[0].dataset.text === trial.correctWho) && (placed[1].dataset.text === trial.correctDoing);
            
            // Log with Target Sentence
            trialLog.push({ 
                trialNum: currentIndex + 1, 
                targetSentence: `${trial.correctWho} ${trial.correctDoing}`,
                status: isCorrect ? "Pass" : "Fail" 
            });

            if (isCorrect) {
                document.getElementById('feedback').innerText = "‚úî Correct!";
                document.getElementById('feedback').style.color = "#2ecc71";
                score++; document.getElementById('score-val').innerText = score;
                document.getElementById(`node-${currentIndex}`).classList.add('node-complete');

                const rand = funkyKeys[Math.floor(Math.random() * funkyKeys.length)];
                activeSound = sounds[rand];
                activeSound.volume = 0; 
                activeSound.currentTime = 0;
                activeSound.play();

                speak(placed.map(n => n.dataset.text).join(" "), () => {
                    const overlay = document.getElementById('dance-overlay');
                    const img = document.getElementById('dance-gif');
                    img.src = danceGifs[Math.floor(Math.random() * danceGifs.length)] + "?t=" + Date.now();
                    overlay.style.display = "flex";
                    overlay.classList.add('funky-pulse');
                    activeSound.volume = 1.0; 
                    danceFader = setTimeout(() => fadeOutActiveSound(overlay), 6000);
                });
            } else {
                document.getElementById('feedback').innerText = "‚úò Try again!";
                document.getElementById('feedback').style.color = "#e74c3c";
                sounds.incorrect.currentTime = 0; sounds.incorrect.play();
            }
            document.getElementById('check-btn').style.display = "none";
            document.getElementById('next-btn').style.display = "inline-block";
        }

        function fadeOutActiveSound(overlayElement) {
            if (!activeSound) return;
            let vol = 1.0;
            const f = setInterval(() => {
                if (vol > 0.1) { vol -= 0.1; activeSound.volume = vol; }
                else { 
                    clearInterval(f); activeSound.pause(); activeSound.volume = 1.0; 
                    overlayElement.style.display = "none"; 
                    overlayElement.classList.remove('funky-pulse');
                }
            }, 150);
        }

        function nextTrial() { 
            globalTrialId++; window.speechSynthesis.cancel(); clearTimeout(danceFader);
            document.getElementById('dance-overlay').style.display = "none";
            if (activeSound) { activeSound.pause(); activeSound.currentTime = 0; activeSound.volume = 1.0; activeSound = null; }
            currentIndex++; 
            if (currentIndex < 10) loadTrial(); else showResults(); 
        }

        function showResults() {
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-pct').innerText = (score / 10 * 100) + "%";
            
            // Build 3-column table
            document.getElementById('log-body').innerHTML = trialLog.map(t => `
                <tr>
                    <td>${t.trialNum}</td>
                    <td>${t.targetSentence}</td>
                    <td style="color:${t.status==='Pass'?'#2ecc71':'#e74c3c'}; font-weight:bold;">${t.status}</td>
                </tr>
            `).join("");
            
            if (score >= 8) {
                const cOverlay = document.getElementById('celebration-overlay');
                const timeStr = "?t=" + Date.now();
                document.getElementById('celebration-gif').src = "images/dancing_cartoon.gif" + timeStr;
                document.getElementById('result-party-left').src = "images/dancing_cartoon.gif" + timeStr;
                document.getElementById('result-party-right').src = "images/dancing_cartoon.gif" + timeStr;

                cOverlay.style.display = 'flex';
                cOverlay.style.opacity = '1';
                sounds.celebration.currentTime = 0;
                sounds.celebration.play();

                setTimeout(() => {
                    cOverlay.style.opacity = '0';
                    setTimeout(() => { cOverlay.style.display = 'none'; }, 1500);
                }, 4000);
            } else {
                document.getElementById('result-party-left').style.display = 'none';
                document.getElementById('result-party-right').style.display = 'none';
            }
        }
    </script>
</body>
</html>
