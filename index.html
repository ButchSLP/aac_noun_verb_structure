<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AAC Noun + Verb - Polished Edition</title>
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <style>
        /* UI Layout & Game Styles */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        body { display: flex; align-items: center; justify-content: center; padding: 10px; box-sizing: border-box; }
        #fullscreen-btn { position: absolute; top: 10px; right: 10px; padding: 8px 15px; font-size: 0.8rem; background: #34495e; color: white; border-radius: 5px; z-index: 100; cursor: pointer; }
        #game-container, #result-screen { width: 98%; max-width: 1200px; height: 92vh; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; box-sizing: border-box; position: relative; }
        #stats-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; background: #f8f9fa; padding: 10px; border-radius: 10px; flex-shrink: 0; }
        #main-content { display: flex; flex-direction: row; gap: 20px; flex-grow: 1; min-height: 0; }
        #gif-container { flex: 1.2; background: #eee; border-radius: 15px; display: flex; align-items: center; justify-content: center; border: 2px solid #ddd; overflow: hidden; }
        #trial-gif { max-width: 100%; max-height: 100%; object-fit: contain; }
        #workspace { flex: 1; display: flex; flex-direction: column; gap: 10px; min-width: 320px; }
        #drop-zone { flex-shrink: 0; display: flex; gap: 10px; padding: 15px; background: #fff; border: 3px dashed #3498db; min-height: 140px; border-radius: 15px; justify-content: center; align-items: center; }
        .bank { flex-grow: 1; display: flex; gap: 10px; justify-content: center; align-content: center; flex-wrap: wrap; padding: 15px; background: #f9f9f9; border-radius: 10px; border: 2px solid #eee; }
        
        /* AAC Symbol Styles */
        .symbol { padding: 8px; border-radius: 12px; cursor: grab; font-weight: bold; width: 135px; min-height: 120px; font-size: 0.95rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box; user-select: none; }
        .symbol img { width: 65px; height: 65px; object-fit: contain; margin-bottom: 5px; pointer-events: none; }
        .who { background: #E0E0E0; border: 4px solid #FFFF00; } 
        .doing { background: #E0E0E0; border: 4px solid #2ECC71; } 
        .dragging { opacity: 0.3; }
        
        #feedback { font-weight: bold; font-size: 1.2rem; height: 30px; text-align: center; }
        .action-area { display: flex; justify-content: center; padding-top: 5px; }
        button { padding: 12px 30px; font-size: 1rem; cursor: pointer; border-radius: 50px; border: none; font-weight: bold; transition: 0.3s; }
        #check-btn { background: #3498db; color: white; }
        #next-btn { background: #2ecc71; color: white; display: none; }

        /* Celebration Overlays */
        #celebration-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        #celebration-gif { max-width: 70%; max-height: 60%; border-radius: 20px; }
        .celebration-text { font-size: 2.5rem; color: #2ecc71; font-weight: bold; margin-bottom: 20px; }

        /* Lobby & Audio Unlock */
        #audio-unlock-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: linear-gradient(-45deg, #3498db, #2ecc71, #9b59b6);
            background-size: 400% 400%;
            animation: gradientBG 10s ease infinite;
            color: white; z-index: 3000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .start-card {
            background: rgba(255, 255, 255, 0.2); padding: 50px; border-radius: 40px;
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.3); box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .pulse-button {
            background: white; color: #3498db; font-size: 2.2rem; padding: 20px 60px;
            border-radius: 100px; border: none; cursor: pointer; font-weight: bold;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255,255,255,0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0); }
        }

        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.9rem; }
        th { background-color: #f2f2f2; }
        .pass { color: #27ae60; font-weight: bold; }
        .fail { color: #e74c3c; font-weight: bold; }

        @media (max-width: 850px) { #main-content { flex-direction: column; } #gif-container { flex: none; height: 250px; } }
    </style>
</head>
<body>

    <div id="audio-unlock-overlay">
        <div class="start-card">
            <h1 style="font-size: 3.2rem; margin-bottom: 10px;">üê∂ Let's Build Sentences!</h1>
            <p style="font-size: 1.3rem; margin-bottom: 30px; opacity: 0.9;">Watch the action and pick the words.</p>
            <button class="pulse-button" onclick="startApp()">START</button>
        </div>
    </div>

    <button id="fullscreen-btn" onclick="toggleFullScreen()">‚õ∂ Full Screen</button>

    <div id="celebration-overlay">
        <div class="celebration-text">Amazing Job!</div>
        <img id="celebration-gif" src="images/dancing_cartoon.gif" alt="Celebration!">
    </div>

    <div id="game-container">
        <div id="stats-header">
            <span>Trial: <span id="current-trial">1</span> / 10</span>
            <span>Score: <span id="score-val">0</span></span>
        </div>
        <div id="main-content">
            <div id="gif-container"><img id="trial-gif" src="" alt="Loading GIF..."></div>
            <div id="workspace">
                <div id="drop-zone"></div>
                <div class="bank" id="word-bank"></div>
                <div id="feedback"></div>
                <div class="action-area">
                    <button id="check-btn" onclick="checkAnswer()">Check Answer</button>
                    <button id="next-btn" onclick="nextTrial()">Next Trial &rarr;</button>
                </div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <h1 style="margin: 0; color: #2c3e50; font-size: 1.5rem;">Results Summary</h1>
        <div style="font-size: 3rem; color: #3498db;" id="final-pct">0%</div>
        <div style="flex-grow: 1; overflow-y: auto; margin-top: 10px;">
            <table>
                <thead><tr style="background:#f2f2f2;"><th>Trial</th><th>Target Sentence</th><th>Result</th></tr></thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
        <button onclick="location.reload()" style="background:#34495e; color:white; margin-top: 10px;">Restart</button>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const dropSound = new Audio('sounds/drop.mp3');
        const celebrationSong = new Audio('sounds/celebration_song.mp3');
        const incorrectSound = new Audio('sounds/incorrect_answer.mp3');
        const silentHeartbeat = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAP8A/w==");
        silentHeartbeat.loop = true;

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        // Fades audio from current volume to zero
        function fadeAudio(audioElement, durationMs) {
            const startVolume = audioElement.volume;
            const steps = 20;
            const interval = durationMs / steps;
            const volStep = startVolume / steps;

            const fadeEffect = setInterval(() => {
                if (audioElement.volume > volStep) {
                    audioElement.volume -= volStep;
                } else {
                    audioElement.volume = 0;
                    audioElement.pause();
                    clearInterval(fadeEffect);
                    audioElement.volume = startVolume; // Reset for next play
                }
            }, interval);
        }

        function startApp() {
            [dropSound, celebrationSong, incorrectSound, silentHeartbeat].forEach(s => {
                s.play().then(() => { s.pause(); s.currentTime = 0; }).catch(() => {});
            });
            silentHeartbeat.play();
            document.getElementById('audio-unlock-overlay').style.display = 'none';
            loadTrial();
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        // --- DATA & GAMEPLAY ---
        const trialsData = [
             { gif: "images/dog_smelling.gif", correctWho: "The dog", whoImg: "symbols/dog.png", correctDoing: "is smelling", doingImg: "symbols/smell.png", distWho: "The cat", distWhoImg: "symbols/cat.png", distDoing: "is sleeping", distDoingImg: "symbols/sleep.png" },
             { gif: "images/girl_running.gif", correctWho: "The girl", whoImg: "symbols/girl.png", correctDoing: "is running", doingImg: "symbols/run.png", distWho: "The boy", distWhoImg: "symbols/boy.png", distDoing: "is eating", distDoingImg: "symbols/eat.png" },
             { gif: "images/cat_jumping.gif", correctWho: "The cat", whoImg: "symbols/cat.png", correctDoing: "is jumping", doingImg: "symbols/jump.png", distWho: "The bird", distWhoImg: "symbols/bird.png", distDoing: "is flying", distDoingImg: "symbols/fly.png" },
             { gif: "images/boy_eating.gif", correctWho: "The boy", whoImg: "symbols/boy.png", correctDoing: "is eating", doingImg: "symbols/eat.png", distWho: "The teacher", distWhoImg: "symbols/teacher.png", distDoing: "is writing", distDoingImg: "symbols/write.png" },
             { gif: "images/baby_crying.gif", correctWho: "The baby", whoImg: "symbols/baby.png", correctDoing: "is crying", doingImg: "symbols/cry.png", distWho: "The man", distWhoImg: "symbols/man.png", distDoing: "is washing", distDoingImg: "symbols/wash.png" },
             { gif: "images/bird_flying.gif", correctWho: "The bird", whoImg: "symbols/bird.png", correctDoing: "is flying", doingImg: "symbols/fly.png", distWho: "The dog", distWhoImg: "symbols/dog.png", distDoing: "is talking", distDoingImg: "symbols/talk.png" },
             { gif: "images/fish_looking.gif", correctWho: "The fish", whoImg: "symbols/fish.png", correctDoing: "is looking", doingImg: "symbols/look.png", distWho: "The octopus", distWhoImg: "symbols/octopus.png", distDoing: "is dancing", distDoingImg: "symbols/dance.png" },
             { gif: "images/man_cutting.gif", correctWho: "The man", whoImg: "symbols/man.png", correctDoing: "is cutting", doingImg: "symbols/cut.png", distWho: "The woman", distWhoImg: "symbols/woman.png", distDoing: "is holding", distDoingImg: "symbols/hold.png" },
             { gif: "images/man_washing.gif", correctWho: "The man", whoImg: "symbols/man.png", correctDoing: "is washing", doingImg: "symbols/wash.png", distWho: "The baby", distWhoImg: "symbols/baby.png", distDoing: "is crying", distDoingImg: "symbols/cry.png" },
             { gif: "images/girl_reading.gif", correctWho: "The girl", whoImg: "symbols/girl.png", correctDoing: "is reading", doingImg: "symbols/read.png", distWho: "The cat", distWhoImg: "symbols/cat.png", distDoing: "is flying", distDoingImg: "symbols/fly.png" }
        ];

        let currentIndex = 0, score = 0, trialLog = [];

        function loadTrial() {
            const trial = trialsData[currentIndex];
            document.getElementById('current-trial').innerText = currentIndex + 1;
            document.getElementById('trial-gif').src = trial.gif;
            document.getElementById('drop-zone').innerHTML = "";
            document.getElementById('feedback').innerText = "";
            document.getElementById('check-btn').style.display = "inline-block";
            document.getElementById('next-btn').style.display = "none";
            document.getElementById('next-btn').innerText = "Next Trial \u2192";
            
            const bank = document.getElementById('word-bank');
            bank.innerHTML = "";
            const items = [{ text: trial.correctWho, type: "who", img: trial.whoImg }, { text: trial.correctDoing, type: "doing", img: trial.doingImg }, { text: trial.distWho, type: "who", img: trial.distWhoImg }, { text: trial.distDoing, type: "doing", img: trial.distDoingImg }].sort(() => Math.random() - 0.5);
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = `symbol ${item.type}`;
                div.draggable = true;
                div.dataset.type = item.type;
                div.dataset.text = item.text;
                div.innerHTML = `<img src="${item.img}"><span>${item.text}</span>`;
                div.addEventListener('pointerdown', () => speak(item.text));
                div.addEventListener('dragstart', (e) => e.target.classList.add('dragging'));
                div.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                    if (e.target.parentElement.id === "drop-zone") {
                        const s = dropSound.cloneNode(); s.volume = 0.2; s.play();
                    }
                });
                bank.appendChild(div);
            });
        }

        const dropZone = document.getElementById('drop-zone');
        const wordBank = document.getElementById('word-bank');
        [dropZone, wordBank].forEach(zone => {
            zone.addEventListener('dragover', e => e.preventDefault());
            zone.addEventListener('drop', e => {
                const dragging = document.querySelector('.dragging');
                if (dragging) zone.appendChild(dragging);
            });
        });

        function checkAnswer() {
            const placed = Array.from(dropZone.children);
            const trial = trialsData[currentIndex];
            if (placed.length < 2) { document.getElementById('feedback').innerText = "Drag both parts!"; return; }
            
            const isCorrect = placed[0].dataset.type === 'who' && placed[1].dataset.type === 'doing' && 
                              placed[0].dataset.text === trial.correctWho && placed[1].dataset.text === trial.correctDoing;
            
            speak(placed[0].dataset.text + " " + placed[1].dataset.text);
            trialLog.push({ trialNum: currentIndex + 1, sentence: `${trial.correctWho} ${trial.correctDoing}`, status: isCorrect ? "Pass" : "Fail" });

            if (isCorrect) {
                document.getElementById('feedback').innerText = "\u2714 Correct!";
                document.getElementById('feedback').style.color = "#2ecc71";
                score++; document.getElementById('score-val').innerText = score;
                
                celebrationSong.volume = 1.0;
                celebrationSong.currentTime = 0;
                celebrationSong.play();
                
                // MID-GAME FADE: Only fade mid-game. If Trial 10, let it carry over.
                if (currentIndex < 9) {
                    setTimeout(() => { 
                         if (document.getElementById('result-screen').classList.contains('hidden')) {
                            fadeAudio(celebrationSong, 1000); 
                         }
                    }, 4000);
                }
            } else {
                document.getElementById('feedback').innerText = "\u2718 Incorrect";
                document.getElementById('feedback').style.color = "#e74c3c";
                incorrectSound.currentTime = 0; incorrectSound.play();
            }

            document.getElementById('check-btn').style.display = "none";
            document.getElementById('next-btn').style.display = "inline-block";
            if (currentIndex === 9) document.getElementById('next-btn').innerText = "See Results!";
        }

        function nextTrial() { 
            // Manual stop ONLY if moving between trials 1-9.
            // If currentIndex is 9, we are moving to results; don't stop the song!
            if (currentIndex < 9) {
                celebrationSong.pause(); 
                celebrationSong.currentTime = 0; 
                celebrationSong.volume = 1.0;
            }

            currentIndex++; if (currentIndex < 10) loadTrial(); else showResults(); 
        }

        function showResults() {
            silentHeartbeat.pause();
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-pct').innerText = (score / 10 * 100) + "%";
            
            const logBody = document.getElementById('log-body');
            logBody.innerHTML = "";
            trialLog.forEach(item => {
                logBody.innerHTML += `<tr><td>${item.trialNum}</td><td>${item.sentence}</td><td class="${item.status.toLowerCase()}">${item.status}</td></tr>`;
            });

            if (score >= 8) {
                const overlay = document.getElementById('celebration-overlay');
                overlay.style.display = 'flex'; overlay.style.opacity = '1'; overlay.style.transition = 'none';
                
                // In case the last trial was incorrect but they still passed the game:
                if (celebrationSong.paused) {
                    celebrationSong.volume = 1.0; celebrationSong.currentTime = 0; celebrationSong.play();
                }

                // Visual GIF fades after 5s, but audio is NOT faded so it plays to the end.
                setTimeout(() => {
                    overlay.style.transition = 'opacity 1s'; overlay.style.opacity = '0';
                    setTimeout(() => { overlay.style.display = 'none'; }, 1000);
                }, 5000);
            }
        }
    </script>
</body>
</html>
